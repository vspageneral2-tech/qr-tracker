{% extends "base.html" %}
{% block title %}Analytics – Kurukshetra Smart Cards{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  <h1>Analytics</h1>
  <p class="muted">Overview of QR activity, scans, clicks, and CTR. Times shown in IST.</p>

  <!-- Filters -->
  <form method="get" action="/analytics" class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
    <div>
      <label><strong>Date Range</strong></label><br>
      <select name="range" style="padding:8px;border-radius:6px;">
        <option value="7"  {% if range_days == 7 %}selected{% endif %}>Last 7 days</option>
        <option value="30" {% if range_days == 30 %}selected{% endif %}>Last 30 days</option>
        <option value="90" {% if range_days == 90 %}selected{% endif %}>Last 90 days</option>
      </select>
    </div>
    <div>
      <label><strong>Per-link (Choose QR)</strong></label><br>
      <select name="scan_id" style="padding:8px;border-radius:6px;">
        <option value="">(None)</option>
        {% for q in qr_list %}
          <option value="{{ q.scan_id }}" {% if focus_scan_id == q.scan_id %}selected{% endif %}>
            {{ q.qr_label or q.scan_id }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div style="align-self:flex-end;margin-bottom:6px;">
      <button class="btn" type="submit">Apply</button>
    </div>
  </form>

  <!-- Summary cards -->
  <div class="card" style="display:flex; gap:16px; flex-wrap:wrap;">
    <div class="card" style="flex:1; min-width:220px;">
      <h3>Total QRs</h3>
      <div style="font-size:24px; font-weight:700;">{{ total_qrs }}</div>
    </div>
    <div class="card" style="flex:1; min-width:220px;">
      <h3>Total Scans</h3>
      <div style="font-size:24px; font-weight:700;">{{ total_scans }}</div>
    </div>
    <div class="card" style="flex:1; min-width:220px;">
      <h3>Total Clicks</h3>
      <div style="font-size:24px; font-weight:700;">{{ total_clicks }}</div>
    </div>
    <div class="card" style="flex:1; min-width:220px;">
      <h3>Overall CTR</h3>
      <div style="font-size:24px; font-weight:700;">{{ overall_ctr }}</div>
      <div class="muted">Clicks ÷ Scans</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="card" style="display:flex; gap:16px; flex-wrap:wrap;">
    <div class="card" style="flex:2; min-width:320px;">
      <h3>Daily Scans vs Clicks</h3>
      <canvas id="barDaily" height="200"></canvas>
      <p style="margin-top:8px;">
        <a class="btn" href="/analytics/export/daily.csv?range={{ range_days }}">Export Daily CSV</a>
      </p>
    </div>

    <div class="card" style="flex:1; min-width:280px;">
      <h3>Per-link Clicks{% if focus_scan_id %} ({{ focus_scan_id }}){% endif %}</h3>
      <canvas id="pieLinks" height="200"></canvas>
      {% if focus_scan_id %}
        <p style="margin-top:8px;">
          <a class="btn" href="/analytics/export/per_link.csv?range={{ range_days }}&scan_id={{ focus_scan_id }}">Export Per-Link CSV</a>
        </p>
      {% else %}
        <p class="muted">Choose a QR above to see per-link clicks.</p>
      {% endif %}
    </div>
  </div>

  <!-- Per-QR table -->
  <h2>Per-QR Performance</h2>
  <p>
    <a class="btn" href="/analytics/export/per_qr.csv?range={{ range_days }}">Export Per-QR CSV</a>
  </p>
  <table>
    <tr>
      <th>Label</th>
      <th>Scan ID</th>
      <th>Created (IST)</th>
      <th>Scans</th>
      <th>Clicks</th>
      <th>CTR</th>
    </tr>
    {% for r in per_qr_rows %}
    <tr>
      <td>{{ r.qr_label or "" }}</td>
      <td class="nowrap">{{ r.scan_id }}</td>
      <td class="nowrap">{{ r.created_local }}</td>
      <td>{{ r.scans }}</td>
      <td>{{ r.clicks }}</td>
      <td>{{ r.ctr }}</td>
    </tr>
    {% endfor %}
  </table>

  <p>
    <a class="btn" href="/admin">← Back to Admin</a>
    <a class="btn" href="/generate">Generate QR</a>
  </p>

  <script>
    // Data from server
    const dailyScans = {{ daily_scans|tojson }};
    const dailyClicks = {{ daily_clicks|tojson }};
    const perLinkRows = {{ per_link_rows|tojson }};

    // Build daily labels and values (align by date)
    const daySet = new Set();
    dailyScans.forEach(d => daySet.add(d.day));
    dailyClicks.forEach(d => daySet.add(d.day));
    const labels = Array.from(daySet).sort();

    const scansMap = Object.fromEntries(dailyScans.map(d => [d.day, d.cnt]));
    const clicksMap = Object.fromEntries(dailyClicks.map(d => [d.day, d.cnt]));

    const scansVals = labels.map(d => scansMap[d] || 0);
    const clicksVals = labels.map(d => clicksMap[d] || 0);

    // Bar chart (Daily)
    const ctxBar = document.getElementById('barDaily').getContext('2d');
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Scans',  data: scansVals },
          { label: 'Clicks', data: clicksVals }
        ]
      },
      options: {
        responsive: true,
        scales: { x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } } }
      }
    });

    // Pie chart (per-link)
    const ctxPie = document.getElementById('pieLinks').getContext('2d');
    const pieLabels = perLinkRows.map(r => r.label);
    const pieValues = perLinkRows.map(r => r.cnt);
    new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: pieLabels,
        datasets: [{ data: pieValues }]
      },
      options: { responsive: true }
    });
  </script>
{% endblock %}
